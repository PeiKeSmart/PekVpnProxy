# SharpTunTest - SOCKS5 流量转发工具

SharpTunTest 是一个基于 SharpTun 库的网络工具，可以创建虚拟网络适配器，捕获网络流量，并通过 SOCKS5 代理转发这些流量。这个工具可以帮助您将所有（或特定）网络流量通过 SOCKS5 代理路由，而不仅仅是捕获它们。

## 功能特点

- **创建虚拟网络适配器**：使用 WinTun 驱动程序创建虚拟网络接口
- **自动配置网络环境**：自动设置 IP 地址和路由规则
- **SOCKS5 代理转发**：将捕获的流量通过 SOCKS5 代理转发
- **支持多种协议**：支持 TCP、UDP 和 ICMP（可选）流量
- **避免路由循环**：自动处理代理服务器的路由，避免路由循环
- **自动清理资源**：程序退出时自动清理所有配置

## 系统要求

- Windows 操作系统（Windows 7 或更高版本）
- .NET 6.0 或更高版本
- 管理员权限（用于创建虚拟网络适配器和配置路由）
- WinTun 驱动程序（随程序提供）
- 可用的 SOCKS5 代理服务器

## 安装步骤

1. 确保您的系统已安装 .NET 6.0 或更高版本
2. 下载并解压程序包
3. 确保 `wintun.dll` 文件位于程序目录中（通常是 `bin/Debug/net6.0/` 或 `bin/Release/net6.0/`）

## 使用说明

### 基本使用

1. **以管理员身份运行程序**：
   - 右键点击 `SharpTunTest.exe`，选择"以管理员身份运行"
   - 或在管理员命令提示符中运行程序

2. **选择测试模式**：
   - 选项 1：仅捕获模式 - 只显示通过虚拟适配器的流量
   - 选项 2：SOCKS5 代理模式 - 捕获流量并通过 SOCKS5 代理转发

3. **配置 SOCKS5 代理**（如果选择了 SOCKS5 代理模式）：
   - 输入代理服务器地址（默认：127.0.0.1）
   - 输入代理服务器端口（默认：1080）
   - 输入用户名和密码（如果需要认证）
   - 选择是否处理 ICMP 流量（ping 请求等）

4. **网络配置**：
   - 程序会自动配置虚拟网络适配器的 IP 地址
   - 如果选择了 SOCKS5 代理模式，程序会询问是否要路由所有流量或仅特定目标
   - 程序会自动添加必要的路由规则，包括代理服务器的直接路由

5. **开始使用**：
   - 程序会开始捕获和转发流量
   - 您可以正常使用网络，所有（或指定的）流量都会通过 SOCKS5 代理

6. **退出程序**：
   - 按 Ctrl+C 退出程序
   - 程序会自动清理所有资源，包括连接、路由和网络适配器配置

### 高级使用

#### 仅路由特定流量

如果您不想路由所有流量，可以在程序询问时选择"否"，程序会默认添加 Google DNS（8.8.8.8）和 Cloudflare DNS（1.1.1.1）的路由。您也可以手动添加其他路由：

```
route add [目标IP] mask 255.255.255.255 192.168.56.1
```

#### 手动配置

如果自动配置失败，程序会提示您手动运行必要的命令：

1. 配置虚拟适配器 IP：
   ```
   netsh interface ip set address name="SharpTunTest" static 192.168.56.1 255.255.255.0
   ```

2. 添加代理服务器的直接路由：
   ```
   route add [代理服务器IP] mask 255.255.255.255 [默认网关IP]
   ```

3. 添加全局路由：
   ```
   route add 0.0.0.0 mask 0.0.0.0 192.168.56.1
   ```

## 故障排除

### 常见问题

1. **程序无法创建虚拟适配器**
   - 确保以管理员身份运行程序
   - 确保 `wintun.dll` 文件位于程序目录中
   - 检查是否安装了兼容的 WinTun 驱动程序

2. **无法连接到网络**
   - 确保 SOCKS5 代理服务器正常工作
   - 检查代理服务器的地址、端口和认证信息是否正确
   - 确保代理服务器可以直接访问（不通过虚拟适配器）

3. **路由循环问题**
   - 如果遇到网络连接问题，可能是路由循环导致的
   - 确保代理服务器的直接路由已正确添加
   - 手动运行 `route print` 检查路由表

4. **程序崩溃或异常**
   - 检查是否有其他程序占用了相同的 IP 地址或端口
   - 尝试重新启动计算机后再运行程序

### 手动清理

如果程序异常退出没有清理资源，可以手动执行以下操作：

1. 删除添加的路由：
   ```
   route delete 0.0.0.0
   route delete 8.8.8.8
   route delete 1.1.1.1
   ```

2. 重置网络适配器：
   ```
   netsh interface ip set address name="SharpTunTest" dhcp
   ```

## 技术原理

SharpTunTest 使用 WinTun 驱动程序创建一个虚拟网络适配器，该适配器可以在 OSI 模型的第 3 层（网络层）捕获和处理 IP 数据包。程序通过配置路由表，将特定（或所有）流量引导到这个虚拟适配器，然后捕获这些数据包，通过 SOCKS5 代理转发它们。

主要工作流程：

1. 创建虚拟网络适配器
2. 配置适配器 IP 地址
3. 添加路由规则
4. 捕获经过适配器的 IP 数据包
5. 解析数据包，提取目标信息
6. 通过 SOCKS5 代理创建到目标的连接
7. 转发数据包内容
8. 接收响应并发送回原始请求者

## 注意事项

- 本工具仅供学习和研究使用
- 使用前请确保您了解并遵守当地的法律法规
- 路由所有流量可能会影响网络性能
- 某些应用程序可能不兼容 SOCKS5 代理
- ICMP 支持是实验性的，可能不适用于所有 SOCKS5 代理服务器

## 许可证

本项目基于 MIT 许可证开源。详情请参阅 LICENSE 文件。
